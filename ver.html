<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Ventas</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-primary">
        <div class="container">        
          <a class="navbar-brand fs-5 fw-bold text-white" href="#">Ventas</a>
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link fs-6 fw-bold text-white" href="index.html">lista</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fs-6 fw-bold text-white" href="agregar.html">agregar</a>
            </li>
          </ul>
        </div>
      </nav>
      <div class="container mt-3">
        <div class="alert alert-danger invisible" id="errores">
            <p></p>
        </div>
        </div>
    <div class="container mt-3">
        <form action="">
            <div class="mb-3 mt-3">
                <label for="txt_id" class="form-label">id</label>
                <input type="text" class="form-control" id="txt_id" name="txt_id" disabled>
            </div>
            <div class="mb-3">
                <label for="cliente" class="form-label">Cliente</label>
                <input type="text" class="form-control" id="cliente" name="cliente">
            </div>
            <div class="mb-3 mt-3">
                <label for="vendedor" class="form-label">Vendedor</label>
                <input type="text" class="form-control" id="vendedor" name="vendedor">
            </div>
            <div class="mb-3">
                <label for="fecha_instalacion" class="form-label">Fecha Instalación</label>
                <input type="date" class="form-control" id="fecha_instalacion" name="fecha_instalacion">
            </div>
            <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select id="estado" name="estado" class="form-control">
                    <option value="instalada">Instalada</option>
                    <option value="pendiente">Pendiente</option>
                </select>
            </div>
            <div class="row mb-3 mt-5">
                <div class="col-2">
                    <button type="button" class="w-100 btn btn-primary fw-bold" onclick="guardar_modificaciones()">Guardar</button>
                </div>
                <div class="col-2">
                    <button type="button" class="w-100 btn btn-primary fw-bold" onclick="window.location.href = 'index.html'">Volver a la lista</button>                
                </div>
                <div class="col-8">
                    <button type="button" class="w-25 btn btn-danger float-end fw-bold" onclick="ver_borrar_venta()">Borrar</button>
                </div>
            </div>
            </form>   
    </div>
<script>
    window.onload = function () {
        let id = new URLSearchParams(window.location.search).get('id')
        cargar_venta(id)
    }

    function cargar_venta(id){
        fetch("http://127.0.0.1:3000/api/ventas/" + id) 
        .then( (res) => { 
            return res.json();
        })
        .then( (datos) => {
            document.getElementById('txt_id').value = datos.id
            document.getElementById('cliente').value = datos.cliente
            document.getElementById('vendedor').value = datos.vendedor
            document.getElementById('fecha_instalacion').value = datos.fechaInstalacion
            document.getElementById('estado').value = datos.estado
        })        
    }

    function guardar_modificaciones(){
        id = document.getElementById('txt_id').value
        var venta = {
                id: id,
                cliente: document.getElementById('cliente').value,
                vendedor: document.getElementById('vendedor').value,
                fechaInstalacion: document.getElementById('fecha_instalacion').value,
                estado: document.getElementById('estado').value
            }
        
        let dato = JSON.stringify(venta)
        console.log(dato)        

        fetch("http://127.0.0.1:3000/api/ventas/" + id, { 
            method: 'PUT',
            body: dato,
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json', 
                }
        }).then( (res) => {
            if (res.ok) {
                return res.json().then(
                    (datos) => {            
                        console.log(datos)   
                        window.location.href = 'index.html'                              
                    }
                )
            } else if (res.status === 404) {    
                return res.json().then(
                    (datos) => {            
                        console.log(datos)                           
                        let e = document.getElementById('errores')
                        e.innerHTML = JSON.stringify(datos.message)
                        e.classList.remove('invisible')
                    }
                )
            } else {
                return res.json().then(
                    (datos) => {            
                        console.log(datos)                           
                        let e = document.getElementById('errores')
                        e.innerHTML = 'se produjo un error al intentar modificar la venta'
                        e.classList.remove('invisible')
                    }
                )
            }     
        }).catch((error) => {
            console.log(error)
        })            
    }

    function ver_borrar_venta(){
        if (confirm("¿Confirma borrar la venta") == true) {
            borrar_venta()
        }
    }    

    function borrar_venta(){
        id = document.getElementById('txt_id').value

        fetch("http://127.0.0.1:3000/api/ventas/" + id, { 
            method: 'DELETE',
            //body: dato,
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json', 
                }
        }).then( (res) => {
            return res.json();
        }).then( (datos) => {            
            console.log(datos)     
            window.location.href = 'index.html'       
        }).catch((error) => {
            console.log(error)
        })     
    }
</script>
</body>
</html>
